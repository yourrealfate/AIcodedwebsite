<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Retro Center – Enhanced</title>
  <style>
    /* Reset and Base Styles */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #101010;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    /* Navigation Bar */
    #navBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      z-index: 50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    #navBar .nav-buttons { display: flex; align-items: center; }
    #navBar button {
      margin: 0 5px;
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #1c8adb;
      color: #fff;
    }
    #navBar button:hover { background: #166bb2; }
    /* Panels: Settings, Games, Leaderboard */
    #settingsPanel, #gamesMenu, #leaderboardPanel {
      position: fixed;
      background: rgba(0,0,0,0.9);
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 40;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    #settingsPanel { top: 70px; right: 10px; max-width: 250px; }
    #gamesMenu { top: 70px; left: 10px; max-width: 200px; }
    #leaderboardPanel { bottom: 10px; left: 10px; max-width: 300px; max-height: 300px; overflow-y: auto; }
    #settingsPanel label, #leaderboardPanel label { display: block; margin-top: 10px; }
    #settingsPanel input[type="color"],
    #settingsPanel input[type="range"],
    #settingsPanel select {
      width: 100%;
      margin-top: 5px;
    }
    /* Main Container (Search Section) */
    #mainContainer {
      position: relative;
      z-index: 10;
      text-align: center;
      padding-top: 80px; /* leave space for nav bar */
    }
    #mainContainer h1 {
      margin-bottom: 20px;
      font-size: 2em;
    }
    .search-box {
      background: rgba(0, 0, 0, 0.65);
      padding: 20px;
      border-radius: 8px;
      display: inline-block;
      margin-bottom: 20px;
    }
    .search-box input[type="text"] {
      padding: 10px;
      width: 300px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      margin-right: 10px;
    }
    .search-box button,
    .search-box select {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #1c8adb;
      color: #fff;
    }
    .search-box button:hover { background: #166bb2; }
    .search-box select { margin-bottom: 10px; }
    /* Game Containers – Fullscreen on most Chromebook screens */
    .gameContainer {
      display: none;
      position: absolute;
      top: 60px;
      left: 0;
      width: 100vw;
      height: calc(100vh - 60px);
      background: #000;
      z-index: 20;
      text-align: center;
    }
    .gameContainer canvas {
      background: #111;
      max-width: 90%;
      max-height: 90%;
      margin: auto;
      display: block;
    }
    .gameContainer button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #1c8adb;
      color: #fff;
      cursor: pointer;
    }
    .gameContainer button:hover { background: #166bb2; }
    /* Floating Shapes (Background effect) */
    .shape {
      position: absolute;
      animation: float 8s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translateY(0); opacity: 0.7; }
      50% { transform: translateY(-30px); opacity: 0.3; }
      100% { transform: translateY(0); opacity: 0.7; }
    }
    /* Flappy Bird Start Overlay */
    #flappyStartOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Flappy Bird Score Display */
    #flappyScoreDisplay {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #fff;
      z-index: 35;
    }
    /* Leaderboard List Style */
    .leaderboard-list {
      list-style-type: decimal;
      padding-left: 20px;
    }
    .leaderboard-list li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div id="navBar">
    <div class="nav-buttons">
      <button id="homeBtn">Home</button>
    </div>
    <div class="nav-buttons">
      <button id="nettleBtn">NettleWeb</button>
      <button id="toggleSettingsBtn">Settings</button>
      <button id="gamesBtn">Games</button>
      <button id="leaderboardBtn">Leaderboard</button>
    </div>
  </div>

  <!-- Settings Panel -->
  <div id="settingsPanel">
    <strong>Customize Look</strong>
    <label for="bgColorPicker">Page Background Color:</label>
    <input type="color" id="bgColorPicker" value="#101010">
    <label for="bgBrightnessSlider">Background Brightness:</label>
    <input type="range" id="bgBrightnessSlider" min="0.5" max="1.5" step="0.01" value="1">
    <label for="textboxColorPicker">Textbox Color:</label>
    <input type="color" id="textboxColorPicker" value="#ffffff">
    <label for="shapeColorPicker">Floating Shape Color:</label>
    <input type="color" id="shapeColorPicker" value="#ffffff">
    <label for="shapeTypeSelect">Shape Type:</label>
    <select id="shapeTypeSelect">
      <option value="circle">Circle</option>
      <option value="square">Square</option>
    </select>
    <label for="shapeCountSlider">Number of Shapes:</label>
    <input type="range" id="shapeCountSlider" min="10" max="50" step="1" value="20">
    <label for="flappyBgPicker">Flappy Bird BG Color:</label>
    <input type="color" id="flappyBgPicker" value="#70c5ce">
  </div>

  <!-- Games Menu -->
  <div id="gamesMenu">
    <strong>Games</strong>
    <button id="flappyBtn">Flappy Bird</button>
    <button id="snakeBtn">Snake</button>
    <button id="pacmanBtn">Pacman</button>
    <button id="closeGamesBtn">Close</button>
  </div>

  <!-- Leaderboard Panel -->
  <div id="leaderboardPanel">
    <strong>Leaderboard</strong>
    <div id="leaderboardContent"></div>
    <button id="refreshLeaderboardBtn">Refresh Leaderboard</button>
  </div>

  <!-- Main Container (Retro Games & Search) -->
  <div id="mainContainer">
    <h1>Retro Games</h1>
    <div class="search-box">
      <label for="proxySelect">Choose Proxy:</label>
      <select id="proxySelect">
        <option value="">None</option>
        <option value="https://holyunblocker.org/?go=">Holy Unblocker</option>
        <option value="https://titanium-proxy.example.com/?go=">Titanium Proxy</option>
      </select>
      <br><br>
      <input type="text" id="searchInput" placeholder="Enter URL or search query..." required>
      <button id="searchBtn">Go</button>
    </div>
  </div>

  <!-- Flappy Bird Game Container -->
  <div class="gameContainer" id="flappyGame">
    <h2>Flappy Bird</h2>
    <canvas id="flappyCanvas"></canvas>
    <!-- Start Overlay -->
    <div id="flappyStartOverlay">
      <button id="flappyStartBtn" style="padding:10px 20px; font-size:18px;">Start</button>
    </div>
    <div style="margin-top:10px;">
      <button id="flappyRestartBtn" style="display:none;">Restart</button>
    </div>
    <div id="flappyScoreDisplay"></div>
  </div>

  <!-- Snake Game Container -->
  <div class="gameContainer" id="snakeGame">
    <h2>Snake</h2>
    <canvas id="snakeCanvas"></canvas>
    <br>
    <button id="snakeRestartBtn" style="display:none;">Restart</button>
  </div>

  <!-- Pacman Game Container -->
  <div class="gameContainer" id="pacmanGame">
    <h2>Pacman</h2>
    <canvas id="pacmanCanvas"></canvas>
    <br>
    <button id="pacmanRestartBtn" style="display:none;">Restart</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      /* --- Responsive Canvas Sizing --- */
      function setCanvasSize(canvas, widthFactor, heightFactor) {
        // Use a percentage of viewport width and height (minus nav bar height)
        canvas.width = Math.floor(window.innerWidth * widthFactor);
        canvas.height = Math.floor((window.innerHeight - 60) * heightFactor);
      }
      function resizeAllCanvases() {
        setCanvasSize(document.getElementById("flappyCanvas"), 0.9, 0.9);
        setCanvasSize(document.getElementById("snakeCanvas"), 0.9, 0.9);
        setCanvasSize(document.getElementById("pacmanCanvas"), 0.9, 0.9);
      }
      resizeAllCanvases();
      window.addEventListener("resize", resizeAllCanvases);

      /* --- Global Variables --- */
      var currentGame = ""; // "flappy", "snake", "pacman"
      
      /* --- Navigation --- */
      document.getElementById("homeBtn").addEventListener("click", function() {
        stopCurrentGame();
        hideAllGameContainers();
        document.getElementById("mainContainer").style.display = "block";
      });
      document.getElementById("nettleBtn").addEventListener("click", function() {
        window.open("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiID8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTI4MCIgaGVpZ2h0PSI3MjAiIHZpZXdCb3g9IjAgMCAxMjgwIDcyMCI+Cgk8dGl0bGU+R29vZ2xlPC90aXRsZT4KCTxmb3JlaWduT2JqZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjcyMCI+CgkJPGVtYmVkIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzcmM9Imh0dHBzOi8vbmV0dGxld2ViLmNvbS8iIHR5cGU9InRleHQvcGxhaW4iIHdpZHRoPSIxMjYwIiBoZWlnaHQ9IjcwMCIgLz4KCTwvZm9yZWduT2JqZWN0Pgo8L3N2Zz4=", "_blank");
      });
      document.getElementById("toggleSettingsBtn").addEventListener("click", function() {
        var panel = document.getElementById("settingsPanel");
        panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
      });
      document.getElementById("gamesBtn").addEventListener("click", function() {
        var menu = document.getElementById("gamesMenu");
        menu.style.display = (menu.style.display === "none" || menu.style.display === "") ? "block" : "none";
      });
      document.getElementById("closeGamesBtn").addEventListener("click", function() {
        document.getElementById("gamesMenu").style.display = "none";
      });
      document.getElementById("leaderboardBtn").addEventListener("click", function() {
        var lb = document.getElementById("leaderboardPanel");
        lb.style.display = (lb.style.display === "none" || lb.style.display === "") ? "block" : "none";
        refreshLeaderboard();
      });
      document.getElementById("refreshLeaderboardBtn").addEventListener("click", refreshLeaderboard);

      /* --- Search Functionality --- */
      document.getElementById("searchBtn").addEventListener("click", function() {
        var query = document.getElementById("searchInput").value.trim();
        if (!query) return;
        var targetUrl = query;
        if (!/^https?:\/\//i.test(query)) {
          if (query.indexOf(" ") !== -1 || query.indexOf(".") === -1)
            targetUrl = "https://www.google.com/search?q=" + encodeURIComponent(query);
          else
            targetUrl = "https://" + query;
        }
        var proxyBase = document.getElementById("proxySelect").value;
        if (proxyBase) { targetUrl = proxyBase + encodeURIComponent(targetUrl); }
        var newWin = window.open("about:blank", "_blank");
        newWin.document.write(`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0; url=${targetUrl}">
  <title>Redirecting...</title>
</head>
<body>
  <p>Redirecting, please wait...</p>
</body>
</html>`);
        newWin.document.close();
      });

      /* --- Floating Shapes --- */
      function generateShapes() {
        document.querySelectorAll('.shape').forEach(function(elem) { elem.remove(); });
        var count = parseInt(document.getElementById("shapeCountSlider").value);
        var color = document.getElementById("shapeColorPicker").value;
        var type = document.getElementById("shapeTypeSelect").value;
        for (var i = 0; i < count; i++) {
          var shape = document.createElement("div");
          shape.className = "shape";
          var size = Math.floor(Math.random() * 50) + 20;
          shape.style.width = size + "px";
          shape.style.height = size + "px";
          shape.style.left = Math.random() * window.innerWidth + "px";
          shape.style.top = Math.random() * window.innerHeight + "px";
          shape.style.animationDuration = (Math.random() * 20 + 10) + "s";
          shape.style.animationDelay = (Math.random() * 5) + "s";
          shape.style.backgroundColor = color;
          shape.style.borderRadius = (type === "circle" ? "50%" : "0%");
          document.body.appendChild(shape);
        }
      }
      generateShapes();
      window.addEventListener("resize", generateShapes);
      document.getElementById("bgColorPicker").addEventListener("input", function(){
        document.body.style.backgroundColor = this.value;
      });
      document.getElementById("bgBrightnessSlider").addEventListener("input", function(){
        document.body.style.filter = "brightness(" + this.value + ")";
      });
      document.getElementById("textboxColorPicker").addEventListener("input", function(){
        document.getElementById("searchInput").style.backgroundColor = this.value;
      });
      document.getElementById("shapeColorPicker").addEventListener("input", generateShapes);
      document.getElementById("shapeTypeSelect").addEventListener("change", generateShapes);
      document.getElementById("shapeCountSlider").addEventListener("input", generateShapes);
      document.getElementById("flappyBgPicker").addEventListener("input", function(){
        document.getElementById("flappyGame").style.backgroundColor = this.value;
      });

      /* --- Leaderboard Functions --- */
      function getLeaderboard(gameKey) {
        var data = localStorage.getItem("leaderboard_" + gameKey);
        return data ? JSON.parse(data) : [];
      }
      function updateLeaderboard(gameKey, score, name) {
        var board = getLeaderboard(gameKey);
        board.push({name: name, score: score});
        board.sort(function(a, b){ return b.score - a.score; });
        board = board.slice(0, 10);
        localStorage.setItem("leaderboard_" + gameKey, JSON.stringify(board));
      }
      function refreshLeaderboard() {
        var lbContent = "";
        [["Flappy Bird", "flappy_bird"], ["Snake", "snake"], ["Pacman", "pacman"]].forEach(function(game) {
          var board = getLeaderboard(game[1]);
          lbContent += "<strong>" + game[0] + " Leaderboard</strong><ol class='leaderboard-list'>";
          board.forEach(function(entry) {
            lbContent += "<li>" + entry.name + " - " + entry.score + "</li>";
          });
          lbContent += "</ol>";
        });
        document.getElementById("leaderboardContent").innerHTML = lbContent;
        // Auto-refresh every 5 hours
        setTimeout(refreshLeaderboard, 5 * 60 * 60 * 1000);
      }

      /* --- Game Management Functions --- */
      function hideAllGameContainers() {
        document.getElementById("flappyGame").style.display = "none";
        document.getElementById("snakeGame").style.display = "none";
        document.getElementById("pacmanGame").style.display = "none";
      }
      function stopCurrentGame() {
        if (currentGame === "flappy") {
          document.removeEventListener("keydown", flappyKeyHandler);
          clearInterval(flappyInterval);
        } else if (currentGame === "snake") {
          document.removeEventListener("keydown", snakeKeyHandler);
          clearInterval(snakeInterval);
        } else if (currentGame === "pacman") {
          document.removeEventListener("keydown", pacmanKeyHandler);
          clearInterval(pacmanInterval);
        }
        currentGame = "";
      }

      /* --- Flappy Bird Game --- */
      var flappyCanvas = document.getElementById("flappyCanvas"),
          flappyCtx = flappyCanvas.getContext("2d");
      // Preload images for flappy (duck skin and pipe)
      var duckImage = new Image();
      duckImage.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Duck_icon_round.svg/64px-Duck_icon_round.svg.png";
      var pipeImage = new Image();
      pipeImage.src = "https://via.placeholder.com/50x200/228B22/ffffff?text=Pipe";
      var flappyPlays = parseInt(localStorage.getItem("flappyPlays") || "0");
      var flappySkinUnlocked = (flappyPlays >= 10);
      var flappyBird, gravity, lift, pipes, pipeGap, pipeWidth, flappyScore, flappyGameOver, flappyInterval;
      
      function resetFlappyGame() {
        flappyPlays++;
        localStorage.setItem("flappyPlays", flappyPlays);
        if (flappyPlays >= 10) flappySkinUnlocked = true;
        setCanvasSize(flappyCanvas, 0.9, 0.9);
        flappyBird = { x: 80, y: flappyCanvas.height / 2, radius: 15, velocity: 0 };
        gravity = 0.6;
        lift = -10;
        pipes = [];
        pipeGap = 120;
        pipeWidth = 50;
        flappyScore = 0;
        flappyGameOver = false;
        // Add one starting pipe
        pipes.push({ x: flappyCanvas.width, top: Math.random() * (flappyCanvas.height - pipeGap - 50) + 20 });
        clearInterval(flappyInterval);
        document.removeEventListener("keydown", flappyKeyHandler);
      }
      function initFlappy() {
        resetFlappyGame();
        document.addEventListener("keydown", flappyKeyHandler);
        flappyCanvas.addEventListener("mousedown", flappyFlap);
        flappyInterval = setInterval(updateFlappy, 20);
      }
      function flappyKeyHandler(e) {
        if (e.code === "Space") flappyFlap();
      }
      function flappyFlap() {
        flappyBird.velocity = lift;
      }
      function updateFlappy() {
        flappyBird.velocity += gravity;
        flappyBird.y += flappyBird.velocity;
        if (flappyBird.y + flappyBird.radius >= flappyCanvas.height || flappyBird.y - flappyBird.radius <= 0)
          flappyGameOver = true;
        if (pipes.length === 0 || pipes[pipes.length - 1].x < flappyCanvas.width - 200)
          pipes.push({ x: flappyCanvas.width, top: Math.random() * (flappyCanvas.height - pipeGap - 50) + 20 });
        for (var i = 0; i < pipes.length; i++) { pipes[i].x -= 2; }
        if (pipes.length > 0 && pipes[0].x + pipeWidth < 0) { pipes.shift(); flappyScore++; }
        for (var i = 0; i < pipes.length; i++) {
          var p = pipes[i];
          if (flappyBird.x + flappyBird.radius > p.x && flappyBird.x - flappyBird.radius < p.x + pipeWidth) {
            if (flappyBird.y - flappyBird.radius < p.top || flappyBird.y + flappyBird.radius > p.top + pipeGap)
              flappyGameOver = true;
          }
        }
        document.getElementById("flappyScoreDisplay").innerText = "Score: " + flappyScore;
        flappyCtx.clearRect(0, 0, flappyCanvas.width, flappyCanvas.height);
        // Draw the bird – either as a duck image or a yellow circle
        if (flappySkinUnlocked)
          flappyCtx.drawImage(duckImage, flappyBird.x - flappyBird.radius, flappyBird.y - flappyBird.radius, flappyBird.radius * 2, flappyBird.radius * 2);
        else {
          flappyCtx.fillStyle = "yellow";
          flappyCtx.beginPath();
          flappyCtx.arc(flappyBird.x, flappyBird.y, flappyBird.radius, 0, Math.PI * 2);
          flappyCtx.fill();
        }
        // Draw pipes using the pipe image
        for (var i = 0; i < pipes.length; i++) {
          var p = pipes[i];
          flappyCtx.drawImage(pipeImage, p.x, 0, pipeWidth, p.top);
          flappyCtx.save();
          flappyCtx.translate(p.x, p.top + pipeGap);
          flappyCtx.scale(1, -1);
          flappyCtx.drawImage(pipeImage, 0, 0, pipeWidth, flappyCanvas.height - p.top - pipeGap);
          flappyCtx.restore();
        }
        if (flappyGameOver) {
          clearInterval(flappyInterval);
          var playerName = prompt("Game Over! Enter your name:");
          if (playerName) updateLeaderboard("flappy_bird", flappyScore, playerName);
          document.getElementById("flappyRestartBtn").style.display = "inline-block";
          flappyCtx.fillStyle = "red";
          flappyCtx.font = "40px Arial";
          flappyCtx.fillText("Game Over", flappyCanvas.width / 2 - 100, flappyCanvas.height / 2);
        }
      }
      document.getElementById("flappyRestartBtn").addEventListener("click", function() {
        this.style.display = "none";
        // Show the start overlay again so the player can hit Start to restart.
        document.getElementById("flappyStartOverlay").style.display = "flex";
      });
      
      /* --- Snake Game --- */
      var snakeCanvas = document.getElementById("snakeCanvas"),
          snakeCtx = snakeCanvas.getContext("2d");
      var snake, snakeDirection, snakeFood, snakeSize, snakeGameOver, snakeInterval;
      function snakeKeyHandler(e) {
        var key = e.code;
        if (key === "ArrowUp" && snakeDirection !== "down") snakeDirection = "up";
        else if (key === "ArrowDown" && snakeDirection !== "up") snakeDirection = "down";
        else if (key === "ArrowLeft" && snakeDirection !== "right") snakeDirection = "left";
        else if (key === "ArrowRight" && snakeDirection !== "left") snakeDirection = "right";
      }
      function initSnake() {
        snakeSize = 20;
        snake = [{ x: 200, y: 200 }];
        snakeDirection = "right";
        snakeGameOver = false;
        placeSnakeFood();
        document.addEventListener("keydown", snakeKeyHandler);
        snakeInterval = setInterval(updateSnake, 100);
      }
      function placeSnakeFood() {
        snakeFood = {
          x: Math.floor(Math.random() * (snakeCanvas.width / snakeSize)) * snakeSize,
          y: Math.floor(Math.random() * (snakeCanvas.height / snakeSize)) * snakeSize
        };
      }
      function updateSnake() {
        var head = { x: snake[0].x, y: snake[0].y };
        if (snakeDirection === "right") head.x += snakeSize;
        else if (snakeDirection === "left") head.x -= snakeSize;
        else if (snakeDirection === "up") head.y -= snakeSize;
        else if (snakeDirection === "down") head.y += snakeSize;
        if (head.x < 0 || head.x >= snakeCanvas.width || head.y < 0 || head.y >= snakeCanvas.height)
          snakeGameOver = true;
        for (var i = 0; i < snake.length; i++) {
          if (head.x === snake[i].x && head.y === snake[i].y)
            snakeGameOver = true;
        }
        if (snakeGameOver) {
          clearInterval(snakeInterval);
          snakeCtx.fillStyle = "red";
          snakeCtx.font = "30px Arial";
          snakeCtx.fillText("Game Over", snakeCanvas.width / 2 - 70, snakeCanvas.height / 2);
          var playerName = prompt("Game Over! Enter your name:");
          if (playerName) updateLeaderboard("snake", snake.length - 1, playerName);
          document.getElementById("snakeRestartBtn").style.display = "inline-block";
          return;
        }
        snake.unshift(head);
        if (head.x === snakeFood.x && head.y === snakeFood.y)
          placeSnakeFood();
        else
          snake.pop();
        snakeCtx.clearRect(0, 0, snakeCanvas.width, snakeCanvas.height);
        snakeCtx.fillStyle = "lime";
        for (var i = 0; i < snake.length; i++) {
          snakeCtx.fillRect(snake[i].x, snake[i].y, snakeSize, snakeSize);
        }
        snakeCtx.fillStyle = "orange";
        snakeCtx.fillRect(snakeFood.x, snakeFood.y, snakeSize, snakeSize);
      }
      document.getElementById("snakeRestartBtn").addEventListener("click", function() {
        this.style.display = "none";
        initSnake();
      });
      
      /* --- Pacman Game --- */
      var pacmanCanvas = document.getElementById("pacmanCanvas"),
          pacmanCtx = pacmanCanvas.getContext("2d");
      var pacman, pacmanDirection, pacmanPellets, pacmanSize, pacmanInterval;
      function pacmanKeyHandler(e) {
        var key = e.code;
        if (key === "ArrowUp") pacmanDirection = "up";
        else if (key === "ArrowDown") pacmanDirection = "down";
        else if (key === "ArrowLeft") pacmanDirection = "left";
        else if (key === "ArrowRight") pacmanDirection = "right";
      }
      function initPacman() {
        pacmanSize = 20;
        pacman = { x: pacmanSize, y: pacmanSize, radius: pacmanSize / 2 };
        pacmanDirection = "right";
        pacmanPellets = [];
        for (var i = 0; i < pacmanCanvas.width; i += pacmanSize) {
          for (var j = 0; j < pacmanCanvas.height; j += pacmanSize) {
            pacmanPellets.push({ x: i, y: j, eaten: false });
          }
        }
        document.addEventListener("keydown", pacmanKeyHandler);
        pacmanInterval = setInterval(updatePacman, 150);
      }
      function updatePacman() {
        if (pacmanDirection === "right") pacman.x += pacmanSize;
        else if (pacmanDirection === "left") pacman.x -= pacmanSize;
        else if (pacmanDirection === "up") pacman.y -= pacmanSize;
        else if (pacmanDirection === "down") pacman.y += pacmanSize;
        if (pacman.x >= pacmanCanvas.width) pacman.x = 0;
        if (pacman.x < 0) pacman.x = pacmanCanvas.width - pacmanSize;
        if (pacman.y >= pacmanCanvas.height) pacman.y = 0;
        if (pacman.y < 0) pacman.y = pacmanCanvas.height - pacmanSize;
        pacmanPellets.forEach(function(p) {
          if (!p.eaten && Math.abs(pacman.x - p.x) < pacmanSize && Math.abs(pacman.y - p.y) < pacmanSize)
            p.eaten = true;
        });
        drawPacman();
      }
      function drawPacman() {
        pacmanCtx.clearRect(0, 0, pacmanCanvas.width, pacmanCanvas.height);
        pacmanCtx.fillStyle = "white";
        pacmanPellets.forEach(function(p) {
          if (!p.eaten) {
            pacmanCtx.beginPath();
            pacmanCtx.arc(p.x + pacmanSize / 2, p.y + pacmanSize / 2, 3, 0, Math.PI * 2);
            pacmanCtx.fill();
          }
        });
        pacmanCtx.fillStyle = "yellow";
        pacmanCtx.beginPath();
        pacmanCtx.arc(pacman.x + pacmanSize / 2, pacman.y + pacmanSize / 2, pacman.radius, 0.25 * Math.PI, 1.75 * Math.PI);
        pacmanCtx.lineTo(pacman.x + pacmanSize / 2, pacman.y + pacmanSize / 2);
        pacmanCtx.fill();
        var eatenCount = pacmanPellets.filter(p => p.eaten).length;
        if (eatenCount > parseInt(localStorage.getItem("bestPacman") || "0"))
          localStorage.setItem("bestPacman", eatenCount);
      }
      document.getElementById("pacmanRestartBtn").addEventListener("click", function() {
        this.style.display = "none";
        initPacman();
      });

      /* --- Game Start Listeners --- */
      document.getElementById("flappyBtn").addEventListener("click", function() {
        hideAllGameContainers();
        document.getElementById("flappyGame").style.display = "block";
        document.getElementById("flappyGame").style.backgroundColor = document.getElementById("flappyBgPicker").value;
        currentGame = "flappy";
        // Show the start overlay – the game starts when "Start" is clicked.
        document.getElementById("flappyStartOverlay").style.display = "flex";
      });
      document.getElementById("snakeBtn").addEventListener("click", function() {
        hideAllGameContainers();
        document.getElementById("snakeGame").style.display = "block";
        currentGame = "snake";
        initSnake();
      });
      document.getElementById("pacmanBtn").addEventListener("click", function() {
        hideAllGameContainers();
        document.getElementById("pacmanGame").style.display = "block";
        currentGame = "pacman";
        initPacman();
      });
      
      /* --- Flappy Bird Start Button --- */
      document.getElementById("flappyStartBtn").addEventListener("click", function() {
        document.getElementById("flappyStartOverlay").style.display = "none";
        initFlappy();
      });
      
    });
  </script>
</body>
</html>
